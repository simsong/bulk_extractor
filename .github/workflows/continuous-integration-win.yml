name: BE2 Build/Test/Package on Windows using msys (c++17)

on:
  push:
    branches:
      - '**' # This will trigger the action for all branches
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: 'windows-latest'

    env:
      DEBUG_5G: FALSE
      DEBUG_FAST: TRUE
      MAKE_OPTS: -j2
      PKG_CONFIG: pkgconf
      PKG_CONFIG_PATH: /ucrt64/lib/pkgconfig
      MSYSTEM: UCRT64
      MSYS2_ARG_CONV_EXCL: '*'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: UCRT64
          path-type: inherit

      - name: Extract Version from configure.ac
        shell: msys2 {0}
        id: extract_version
        run: |
          echo "::set-output name=version::$(grep 'AC_INIT(\[BULK_EXTRACTOR\]' configure.ac| cut -d',' -f2 | tr -d "[]")"

      - name: Install MSYS2 packages + libewf
        shell: msys2 {0}
        run: |
          set -euo pipefail

          echo "== Install required MSYS2 packages =="
          pacman -Syu --noconfirm
          pacman -S --needed --noconfirm \
            base-devel automake autoconf libtool pkgconf \
            mingw-w64-ucrt-x86_64-gcc \
            mingw-w64-ucrt-x86_64-make \
            mingw-w64-ucrt-x86_64-re2 \
            mingw-w64-ucrt-x86_64-abseil-cpp \
            mingw-w64-ucrt-x86_64-sqlite3 \
            mingw-w64-ucrt-x86_64-openssl \
            mingw-w64-ucrt-x86_64-expat \
            mingw-w64-ucrt-x86_64-ncurses \
            mingw-w64-ucrt-x86_64-libgcrypt \
            mingw-w64-ucrt-x86_64-libgpg-error
          
          
          echo "== Build libewf from source =="
          LIBEWF_URL="https://github.com/libyal/libewf/releases/download/20240506/libewf-experimental-20240506.tar.gz"
          echo "Installing libewf from source..."
          echo "Using URL: $LIBEWF_URL"
          
          curl -LO "$LIBEWF_URL" || { echo "could not download $LIBEWF_URL"; exit 1; }
          
          tar xfz libewf-*.tar.gz
          
          # Pick the first matching extracted directory
          for d in libewf-*/; do
            LIBEWF_DIR="$d"
            break
          done
          
          cd "$LIBEWF_DIR" || { echo "libewf source dir missing"; exit 1; }

          ./configure --prefix=/ucrt64 
          make -j"$(nproc)"
          make install
          cd ..

          if command -v ewfinfo >/dev/null 2>&1; then
            ewfinfo -h >/dev/null
            echo "libewf successfully installed."
          else
            echo "ERROR: libewf installation failed."
            exit 1
          fi
          
          pkgconf --libs libewf
          pkgconf --cflags libewf

      - name: Version Numbers
        shell: msys2 {0}
        run: |
          autoconf --version
          automake --version
          aclocal --version
          gcc --version
          g++ --version

      - name: printenv
        shell: msys2 {0}
        run: |
          printenv

      - name: Files
        shell: msys2 {0}
        run: |
          find . -print

      - name: Make configure script
        shell: msys2 {0}
        run: |
          bash bootstrap.sh

      - name: Dump configure script
        shell: msys2 {0}
        run: |
          cat configure

      - name: C++ checks not optimization with address-sanitizer
        shell: msys2 {0}
        env:
          MSYSTEM: UCRT64
          MSYS2_ARG_CONV_EXCL: '*'
        run: |
          echo "=== Before injection ==="
          echo "LIBS:    $LIBS"
          echo "LDFLAGS: $LDFLAGS"
          echo "CPPFLAGS: $CPPFLAGS"
          
          echo "=== pkgconf check (libewf) ==="
          pkgconf --print-errors --cflags libewf || echo "no cflags from pkgconf"
          pkgconf --print-errors --libs libewf || echo "no libs from pkgconf"
          pkgconf --print-errors --static --libs libewf || echo "no static libs from pkgconf"
          
          echo "=== Compiler check ==="
          which gcc || echo "gcc not found"
          which g++ || echo "g++ not found"
          gcc -v || echo "gcc -v failed"
          g++ -v || echo "g++ -v failed"
  
          # Expand libewf deps to match Ubuntu build and inject manually
          EXTRA_LIBS="$(pkgconf --static --libs libewf) -lgcrypt -lgpg-error"
          export LIBS="$EXTRA_LIBS $LIBS"
          export LDFLAGS="$LDFLAGS -L/ucrt64/lib"
          
          echo "=== After injection ==="
          echo "EXTRA_LIBS: $EXTRA_LIBS"
          echo "LIBS:       $LIBS"
          echo "LDFLAGS:    $LDFLAGS"
          echo "CPPFLAGS:   $CPPFLAGS"
          
          ./configure --disable-opt --enable-address-sanitizer 
          echo == config.h ==
          cat config.h
          echo ==============
          make $MAKE_OPTS all
          pushd src
          make $MAKE_OPTS bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: Dump config on failure
        if: failure()   # only runs if previous step failed
        shell: msys2 {0}
        run: |
          echo "=== BEGIN config.log ==="
          cat config.log || echo "no config.log found"
          echo "=== END config.log ==="
          echo "=== BEGIN config.status ==="
          cat config.status || echo "no config.status found"
          echo "=== END config.status ==="  

      - name: C++ checks optimization with address-sanitizer
        shell: msys2 {0}
        run: |
          ./configure --enable-address-sanitizer --enable-silent-rules --quiet 
          make $MAKE_OPTS all
          pushd src
          make $MAKE_OPTS bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: C++ checks with thread-sanitizer
        shell: msys2 {0}
        run: |
          bash bootstrap.sh
          ./configure --enable-thread-sanitizer --enable-silent-rules --quiet 
          make clean
          make $MAKE_OPTS all
          pushd src
          make $MAKE_OPTS bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: C++ checks with codecov
        shell: msys2 {0}
        run: |
          bash bootstrap.sh
          ./configure --disable-opt CFLAGS='-g -O0 -fprofile-arcs -ftest-coverage' CXXFLAGS='-g -O0 -fprofile-arcs -ftest-coverage' --enable-silent-rules --quiet
          make clean
          make $MAKE_OPTS check || (echo ==error== ; cat test-suite.log; exit 1)

      - name: upload codecov report
        shell: msys2 {0}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          pushd src
          gcov *.o *.cpp rar/*.cpp rar/*.hpp
          bash <(curl -s https://codecov.io/bash)
          popd

      - name: distcheck
        shell: msys2 {0}
        run: |
          bash bootstrap.sh
          ./configure -q 
          make distcheck

      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bulk_extractor-${{ steps.extract_version.outputs.version }}.tar.gz
          path: bulk_extractor-${{ steps.extract_version.outputs.version }}.tar.gz

      - uses: ammaraskar/gcc-problem-matcher@0.2.0
        name: GCC Problem Matcher
