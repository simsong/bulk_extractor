# This file based on https://gist.github.com/mwouts/9842452d020c08faf9e84a3bba38a66f
# See: https://help.github.com/en/actions/reference/software-installed-on-github-hosted-runners
# 2025-09-16 - ryeates - split *nix and windows out


name: BE2 Build/Test/Package on Windows using msys (c++17)

on:
  push:
    branches:
      - '**' # This will trigger the action for all branches
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: 'windows-latest'

    env:
      DEBUG_5G: FALSE
      DEBUG_FAST: TRUE
      MAKE_OPTS: -j2

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ----------------------------
      # Windows ( mSYS2 UCRT64)
      # ----------------------------
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: ucrt64
          path-type: inherit

      - name: Extract Version from configure.ac
        shell: msys2 {0}
        id: extract_version
        run: |
          echo "::set-output name=version::$(grep 'AC_INIT(\[BULK_EXTRACTOR\]' configure.ac| cut -d',' -f2 | tr -d "[]")"

      # Conditional step for push events
      - name: Run on push
        if: github.event_name == 'push'
        run: echo "This runs on a push to any branch"

      # Conditional step for pull_request events
      - name: Run on pull request
        if: github.event_name == 'pull_request'
        run: echo "This runs on a pull request to the main branch"

      - name: "Windows: run CONFIGURE_WINDOWS.bash"
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          echo "" | bash etc/CONFIGURE_WINDOWS.bash

      - name: Version Numbers
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          autoconf --version
          automake --version
          aclocal --version
          gcc --version
          g++ --version

      - name: printenv
        shell: msys2 {0}
        run: |
          printenv

      - name: Files
        shell: msys2 {0}
        run: |
          find . -print

      - name: Make configure script
        shell: msys2 {0}
        run: |
          bash bootstrap.sh

      - name: Dump configure script
        shell: msys2 {0}
        run: |
          cat configure

      - name: C++ checks not optimization with address-sanitizer (Mac and Linux)
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          ./configure --disable-opt --enable-address-sanitizer
          echo == config.h ==
          cat config.h
          echo ==============
          make $MAKE_OPTS all
          pushd src
          make $MAKE_OPTS bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: C++ checks optimization with address-sanitizer (Mac and Linux)
        shell: msys2 {0}
        run: |
          echo === Try Address Sanitizer Optimization ===
          source $HOME/.bashrc
          ./configure --enable-address-sanitizer --enable-silent-rules --quiet
          make $MAKE_OPTS all
          pushd src
          make $MAKE_OPTS bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: C++ checks with thread-sanitizer on ubuntu are disabled
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          bash bootstrap.sh
          ./configure --enable-thread-sanitizer --enable-silent-rules  --quiet
          make clean
          make $MAKE_OPTS  all
          pushd src
          make $MAKE_OPTS  bulk_extractor
          make check || (cat test-suite.log; exit 1)
          popd
          make distclean

      - name: C++ checks with codecov
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          bash bootstrap.sh
          ./configure --disable-opt CFLAGS='-g -O0 -fprofile-arcs -ftest-coverage' CXXFLAGS='-g -O0 -fprofile-arcs -ftest-coverage' --enable-silent-rules --quiet
          make clean
          make $MAKE_OPTS  check || (echo ==error== ; cat test-suite.log; exit 1)

      - name: upload codecov report
        shell: msys2 {0}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          pushd src
          gcov *.o *.cpp rar/*.cpp rar/*.hpp
          bash <(curl -s https://codecov.io/bash)
          popd

      - name: distcheck
        shell: msys2 {0}
        run: |
          source $HOME/.bashrc
          bash bootstrap.sh
          ./configure -q
          make distcheck

      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bulk_extractor-${{ steps.ctx.outputs.version }}.tar.gz
          path: bulk_extractor-${{ steps.ctx.outputs.version }}.tar.gz

      - uses: ammaraskar/gcc-problem-matcher@0.2.0
        name: GCC Problem Matcher
